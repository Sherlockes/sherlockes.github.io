<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Sherblog" rel="home">
				<div class="logo__title">Sherblog</div>
				<div class="logo__tagline">Sólo mi forma de hacer las cosas...</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menú</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/post/raspberry/">Raspberry Pi</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/tasker/">Tasker</a>
		</li>
	</ul>
</nav>

	</div>
</header>

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Copia de seguridad de la base de datos de WordPress</h1><div class="post__meta meta"></div>
		</header>
		<figure class="post__thumbnail">
			<img src="/images/20170228_db_backup_00.jpg" alt="Copia de seguridad de la base de datos de WordPress">
		</figure><div class="post__content clearfix">
			<p>Hace unos días expliqué como gestiona la copia de seguridad de los archivos de WordPress (la carpeta wp-content) y aquí vamos a ver como hago lo propio con la base de datos. El flujo de trabajo es simple, periódicamente me llega un correo electrónico con la base de datos comprimida como archivo adjunto y guardo ese archivo en mi unidad de Google Drive.</p>

<p>El plugin de WordPress <a href=" https://es.wordpress.org/plugins/wp-db-backup/">WP-DB-Backup</a> es el que se encarga de enviar un correo electrónico periódicamente con la copia de la base de datos. La configuración es muy sencilla, una vez que el plugin está instalado y activo vamos al menú &ldquo;Herramientas - Copia de respaldo&rdquo; del escritorio de WordPress y bajamos hasta la opción &ldquo;Respaldo Programado&rdquo;.</p>

<p><img src="/images/20170228_db_backup_01.jpg" alt="image" /></p>

<p>Seleccionamos la frecuencia del respaldo y las tablas adicionales a respaldar, introducimos la dirección de correo a la que vamos a enviar el respaldo y pulsamos el botón &ldquo;Respaldo Programado&rdquo; para guardar la configuración.</p>

<p>A continuación vamos a crear un programa dentro de Google Apps Script que nos guardará el archivo adjunto en una carpeta de nuestra unidad de Google Drive y borrará el correo electrónico.</p>

<pre><code>// Declaración de variables
var ahora = new Date();
var correos = GmailApp.search(&quot;subject:(*SherBlog Copia de seguridad de la base de datos*) has:attachment&quot;);
var carpeta = DriveApp.searchFolders(&quot;title contains 'sherblog_db_backups'&quot;).next();
var archivos = new Array();
 
// Matrices para distintos rangos de antiguedad 10-20-40-80-160 
var d10 = new Array();
var d20 = new Array();
var d40 = new Array();
var d80 = new Array();
var d160 = new Array();
 
function backup_db() {
  
  // Guardar los archivos adjuntos y borra los correos
  for (var x=0; x&lt;correos.length; x++) {
    var mensaje = correos[x].getMessages()[0];
    var adjuntos = mensaje.getAttachments();
    carpeta.createFile(adjuntos[0]);
    correos[x].moveToTrash();
  }
                 
  // Genera matriz con los archivos ya existentes en carpeta
  archivos = carpeta.getFiles();
  
  while (archivos.hasNext()) {
    archivo = archivos.next();
    // Asigna cada archivo al rango de antiguedad y borra los obsoletos
    if(dias(archivo)&gt;5 &amp;&amp; dias(archivo)&lt;11){d10.push(archivo)};
    if(dias(archivo)&gt;10 &amp;&amp; dias(archivo)&lt;21){d20.push(archivo)};
    if(dias(archivo)&gt;20 &amp;&amp; dias(archivo)&lt;41){d40.push(archivo)};
    if(dias(archivo)&gt;40 &amp;&amp; dias(archivo)&lt;81){d80.push(archivo)};
    if(dias(archivo)&gt;80 &amp;&amp; dias(archivo)&lt;161){d160.push(archivo)};
    if(dias(archivo)&gt;160){archivo.setTrashed(true)};
  }
               
  // Borrar los archivos recientes de cada rango
  limpiar(d10);
  limpiar(d20);
  limpiar(d40);
  limpiar(d80);
  limpiar(d160); 
}
 
// función para contar los días de antiguedad de un archivo
function dias(archiv){
  return(Math.round((ahora - archiv.getLastUpdated())/1000/60/60/24));
}
 
// Función para eliminar los archivos mas recientes de una matriz
function limpiar(matriz){
  while (matriz.length&gt;1){
    if(dias(matriz[0])&gt;dias(matriz[1])){
      matriz[1].setTrashed(true);  //Elimina el archivo más reciente
      matriz.splice(1,1);  //Elimina la entrada de la matriz correspondiente al archivo borrado
    }else{
      matriz[0].setTrashed(true);
      matriz.splice(0,1);
    }
  }
}
</code></pre>

<p>Con esto ya tenemos guardada en nuestra unidad de Google Drive una copia de seguridad de la base de datos de WordPress de la web.</p>

<p>Para el tema del guardado de versiones he optado por un sistema tan simple como efectivo, tal y como se puede ver en el código se guardan los siguientes archivos.</p>

<ul>
<li>Un archivo por cada uno de los cinco últimos días</li>
<li>Un archivo con una antigüedad entre 5 y 10 días</li>
<li>Un archivo con una antigüedad entre 10 y 20 días</li>
<li>Un archivo con una antigüedad entre 20 y 40 días</li>
<li>Un archivo con una antigüedad entre 40 y 80 días</li>
<li>Un archivo con una antigüedad entre 80 y 160 días</li>
</ul>

<p>Y con esto creo que tengo más que suficiente para cubrir mis necesidades ocupando un espacio limitado.</p>

			No me apetece perder nada de tiempo con el <a href="https://rgpd.es">RGPD</a> así que si tienes alguna duda, pregunta o sugerencia no dudes en dejarme un <a href="https://twitter.com/sherblogpro">Tweet</a> en @sherblogpro.  Intentaré responderte o complacerte si se o puedo o inventigar en ello para un nuevo post si no lo conozco.
		</div>
		
	</article>
	
	
<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/flujo-de-trabajo-con-im%C3%A1genes-en-wordpress/" rel="prev"><span class="post-nav__caption">«&thinsp;Anterior</span><p class="post-nav__post-title">Flujo de trabajo con imágenes en WordPress</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/deshabilitar-cache-en-chrome/" rel="next"><span class="post-nav__caption">Siguiente&thinsp;»</span><p class="post-nav__post-title">Deshabilitar cache en chrome</p></a>
	</div>
</nav>
	
</main>


<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Sherblog.
			<span class="footer__copyright-credits">Generado con <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> y <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a>.</span>
		</div>
	</div>
</footer>
